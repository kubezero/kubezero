---
# This ExternalSecret reads the kubeconfig generated by Crossplane DOKS
# and creates an Argo CD-compatible cluster secret in JSON format.
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cluster-secret
  namespace: kubezero
  annotations:
    argocd.argoproj.io/sync-wave: '1'
  labels:
    argocd.argoproj.io/secret-type: cluster
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: kubezero-management
    kind: ClusterSecretStore
  target:
    name: cluster-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      metadata:
        annotations:
          managed-by: external-secrets
        labels:
          argocd.argoproj.io/secret-type: cluster
      data:
        name: "{{ with (.raw_config | fromYaml) }}{{ (index .clusters 0).name }}{{ end }}"
        server: "{{ .host }}"
        config: |
          {
            "bearerToken": "{{ .token }}",
            "tlsClientConfig": {
              "insecure": false,
              "caData": "{{ .cluster_ca_certificate }}"
            }
          }
  data:
    - secretKey: raw_config
      remoteRef:
        key: management-digitalocean-doks-kubeconfig
        property: attribute.kube_config.0.raw_config
    - secretKey: host
      remoteRef:
        key: management-digitalocean-doks-kubeconfig
        property: attribute.kube_config.0.host
    - secretKey: token
      remoteRef:
        key: management-digitalocean-doks-kubeconfig
        property: attribute.kube_config.0.token
    - secretKey: cluster_ca_certificate
      remoteRef:
        key: management-digitalocean-doks-kubeconfig
        property: attribute.kube_config.0.cluster_ca_certificate
